# Copy this file to .kamal/secrets and fill in actual values
# DO NOT commit .kamal/secrets to git!
#
# This file supports environment-specific secrets using KAMAL_DESTINATION
# Use: kamal deploy -d staging  (sets KAMAL_DESTINATION=staging)
#      kamal deploy -d production  (sets KAMAL_DESTINATION=production)

# Use destination-specific 1Password vaults
# Staging: kamal deploy -d staging → uses CoverText/Staging
# Production: kamal deploy -d production → uses CoverText/Production
if [ "$KAMAL_DESTINATION" = "production" ]; then
  VAULT_PATH="CoverText/Production"
else
  VAULT_PATH="CoverText/Staging"
fi

# Fetch secrets from 1Password
# Only need registry password and master key here - database credentials are in Rails encrypted credentials
# Replace account ID with your actual 1Password account ID
SECRETS=$(kamal secrets fetch --adapter 1password --account YOUR_1PASSWORD_ACCOUNT_ID --from ${VAULT_PATH} KAMAL_REGISTRY_PASSWORD RAILS_MASTER_KEY)
KAMAL_REGISTRY_PASSWORD=$(kamal secrets extract KAMAL_REGISTRY_PASSWORD ${SECRETS})
RAILS_MASTER_KEY=$(kamal secrets extract RAILS_MASTER_KEY ${SECRETS})

# Database credentials are accessed via Rails.application.credentials.dig(:database, :password)
# from environment-specific credentials files (config/credentials/staging.yml.enc, production.yml.enc)

# ─────────────────────────────────────────────────────────────────
# 1Password Setup Instructions:
# ─────────────────────────────────────────────────────────────────
# 1. Create two vaults in 1Password:
#    - CoverText/Staging
#    - CoverText/Production
#
# 2. In each vault, add items for:
#    - KAMAL_REGISTRY_PASSWORD (GitHub PAT with write:packages scope)
#    - RAILS_MASTER_KEY (from config/credentials/staging.key or production.key)
#
# 3. Database credentials should be stored in Rails encrypted credentials:
#    bin/rails credentials:edit --environment staging
#    bin/rails credentials:edit --environment production
#
#    Add to each credentials file:
#    database:
#      password: your_postgres_password_here
#      # Or for production with managed Postgres:
#      url: postgres://user:pass@host:25060/db?sslmode=require
# ─────────────────────────────────────────────────────────────────
