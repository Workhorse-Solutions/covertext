## Codebase Patterns
- Use `DATABASE_URL="postgres://jward@localhost/covertext_test"` for local development (Docker config uses "postgres" host which doesn't work outside container)
- Account model follows same validation patterns as Agency (stripe_*_id unique allow_nil, subscription_status with inclusion validation)
- Stripe billing fields (stripe_customer_id, stripe_subscription_id, subscription_status, plan_name) are now on Account, not Agency
- When creating Agency, always provide an Account; signup flow creates Account + Agency + User together
- Billing views/controllers should use @account for subscription info, @agency only for live_enabled status
- User belongs_to :account (not agency); Agency no longer has_many :users
- Signup creates owner role; admin is the default role
- Use `current_user.account.agencies.where(active: true).first` to get current_agency

---

## 2026-01-31 - US-001
Thread: https://ampcode.com/threads/T-019c164b-fdbb-739c-9338-1995d473784f
- Created Account model with name, stripe_customer_id, stripe_subscription_id, subscription_status, plan_name
- Added migration with unique indexes on stripe_customer_id and stripe_subscription_id
- Account has_many :agencies, has_many :users associations
- Created comprehensive model tests (11 tests)
- Files changed:
  - app/models/account.rb (new)
  - db/migrate/20260131230357_create_accounts.rb (new)
  - test/models/account_test.rb (new)
- **Learnings for future iterations:**
  - Database connection configured for Docker; use DATABASE_URL env var for local development
  - Follow existing validation patterns from Agency model for consistency
  - All CI checks pass: tests (170), rubocop, brakeman
---

## 2026-01-31 - US-002
Thread: https://ampcode.com/threads/T-019c1676-e016-764d-a32f-d16a70708e8b
- Added `account_id` foreign key to agencies table (not null, with foreign key constraint)
- Removed Stripe billing columns from agencies (stripe_customer_id, stripe_subscription_id, subscription_status, plan_name)
- Added `active` boolean column to agencies (default: true)
- Agency now `belongs_to :account`
- Updated billing views/controller to use @account for subscription info
- Updated RegistrationsController to create Account + Agency + User in transaction
- Updated test fixtures and all tests referencing old agency Stripe fields
- Files changed:
  - db/migrate/20260131231104_add_account_id_to_agencies.rb (new)
  - app/models/agency.rb (modified - added belongs_to :account, can_go_live?)
  - app/models/account.rb (modified - temporarily removed has_many :users until US-003)
  - app/controllers/registrations_controller.rb (modified - creates Account first)
  - app/controllers/admin/billing_controller.rb (unchanged - already used @account)
  - app/views/admin/billing/show.html.erb (modified - use @account for billing fields)
  - db/seeds.rb (modified - creates Account before Agency)
  - test/fixtures/accounts.yml (new)
  - test/fixtures/agencies.yml (modified - references accounts)
  - Multiple test files updated to use Account for Stripe fields
- **Learnings for future iterations:**
  - Account's `has_many :users` can't exist until users table has account_id (US-003)
  - Tests that create agencies ad-hoc must also create an Account first
  - The signup flow now creates Account + Agency together, not just Agency
  - All CI checks pass: tests (168), rubocop, brakeman
---

## 2026-02-01 - US-003
Thread: https://ampcode.com/threads/T-019c1680-1cd1-7204-ab75-75a8ccc2a27c
- Added `account_id` foreign key to users table (not null)
- Removed `agency_id` foreign key from users table
- User now `belongs_to :account` instead of `belongs_to :agency`
- Account now `has_many :users` (was commented out pending this migration)
- Agency no longer `has_many :users`
- Updated RegistrationsController to create user under account with 'owner' role
- Updated Admin::BaseController.current_agency to use account.agencies.where(active: true).first
- Updated Admin::BillingController to use current_user.account
- Updated all fixtures: john_admin → john_owner, agency → account references
- Files changed:
  - db/migrate/20260201000038_move_user_from_agency_to_account.rb (new)
  - app/models/user.rb (modified - belongs_to :account, added ROLES constant)
  - app/models/account.rb (modified - has_many :users)
  - app/models/agency.rb (modified - removed has_many :users)
  - app/controllers/registrations_controller.rb (modified - user belongs to account)
  - app/controllers/admin/base_controller.rb (modified - current_agency from account)
  - app/controllers/admin/billing_controller.rb (modified - use current_user.account)
  - test/fixtures/users.yml (modified - account references)
  - Multiple test files updated for john_owner fixture name
- **Learnings for future iterations:**
  - Fixture renames require updating ALL test references
  - Agency.has_many :users was causing "agency_id does not exist" errors in seed tests
  - Admin controllers must get agency through account, not directly from user
  - All CI checks pass: tests (168), rubocop, brakeman
---
