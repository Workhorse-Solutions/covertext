<div class="container mx-auto max-w-5xl">
  <h1 class="text-3xl font-bold mb-6">Dashboard</h1>

  <% if !@agency.fully_ready? %>
    <!-- Setup State -->
    <%= render UI::CardComponent.new(class_name: "shadow-xl") do %>
      <h2 class="card-title text-2xl">Get CoverText Ready</h2>
      <p class="text-base-content/70 mb-6">Complete these steps to start receiving client SMS requests.</p>

        <!-- Setup Checklist -->
        <ul class="steps steps-vertical w-full">
          <!-- Step 1: Subscription -->
          <li class="step <%= @agency.subscription_ready? ? 'step-primary' : '' %>" data-content="<%= @agency.subscription_ready? ? '✓' : '1' %>">
            <div class="text-left w-full pl-4">
              <div class="font-semibold">Activate Subscription</div>
              <div class="text-sm text-base-content/70">
                <% if @agency.subscription_ready? %>
                  <%= @account.plan_tier.titleize %> Plan Active
                <% else %>
                  Please <%= link_to "update your billing", admin_billing_path, class: "link link-hover" %> to activate your subscription
                <% end %>
              </div>
            </div>
          </li>

          <!-- Step 2: SMS Number -->
          <li class="step <%= @agency.phone_ready? ? 'step-primary' : '' %>" data-content="<%= @agency.phone_ready? ? '✓' : '2' %>">
            <div class="text-left w-full pl-4">
              <div class="font-semibold">Select SMS Number</div>
              <div class="text-sm text-base-content/70">
                <% if @agency.phone_ready? %>
                  <%= render UI::PhoneNumberComponent.new(number: @agency.phone_sms, class_name: "font-mono") %>
                <% elsif @agency.subscription_ready? %>
                  <button type="button"
                          class="link link-hover link-primary"
                          onclick="phone_provisioning_modal.showModal()">
                    Choose a toll-free number for your agency
                  </button>
                <% else %>
                  Complete step 1 first
                <% end %>
              </div>
            </div>
          </li>

          <!-- Step 3: Verification -->
          <li class="step <%= @agency.verification_ready? ? 'step-primary' : '' %>" data-content="<%= @agency.verification_ready? ? '✓' : '3' %>">
            <div class="text-left w-full pl-4">
              <div class="font-semibold">Submit Verification</div>
              <div class="text-sm text-base-content/70">
                <% if @agency.verification_ready? %>
                  Toll-free verification submitted
                <% elsif @agency.phone_ready? %>
                  <%= link_to "Submit toll-free verification", admin_compliance_path, class: "link link-hover link-primary" %> to enable messaging
                <% else %>
                  Complete step 2 first
                <% end %>
              </div>
            </div>
          </li>
        </ul>
      <% end %>

    <!-- Phone Number Selection Modal -->
    <% if @agency.subscription_ready? && !@agency.phone_ready? %>
      <dialog id="phone_provisioning_modal" class="modal">
        <div class="modal-box max-w-lg">
          <h3 class="text-lg font-bold mb-2">Select SMS Number</h3>
          <%= turbo_frame_tag "phone_number_selection", src: admin_new_phone_provisioning_path, loading: :lazy do %>
            <div class="flex justify-center py-8">
              <span class="loading loading-spinner loading-lg text-primary"></span>
            </div>
          <% end %>
        </div>
        <form method="dialog" class="modal-backdrop">
          <button>close</button>
        </form>
      </dialog>
    <% end %>
  <% else %>
    <!-- Live State -->
    <div class="grid gap-6 md:grid-cols-2">
      <!-- System Status Card -->
      <%= render UI::CardComponent.new(class_name: "shadow-xl") do %>
        <h2 class="card-title">
          <span class="size-6 text-success"><%= heroicon "check-circle", variant: :solid %></span>
          System Ready
        </h2>
        <div class="divider my-2"></div>

        <div class="space-y-3">
          <div>
            <div class="text-sm text-base-content/70">SMS Number</div>
            <div class="font-mono font-semibold"><%= render UI::PhoneNumberComponent.new(number: @agency.phone_sms) %></div>
          </div>

          <div>
            <div class="text-sm text-base-content/70">Subscription</div>
            <div class="font-semibold">
              <%= @account.plan_tier.titleize %> Plan
              <span class="badge badge-success badge-sm ml-2">Active</span>
            </div>
          </div>
        </div>
      <% end %>

      <!-- Usage Summary Card -->
      <%= render UI::CardComponent.new(class_name: "shadow-xl") do %>
        <h2 class="card-title">
          <span class="size-6"><%= heroicon "chart-bar", variant: :solid %></span>
          Usage Summary
        </h2>
        <div class="divider my-2"></div>

        <div class="space-y-3">
          <div>
            <div class="text-sm text-base-content/70">Total Requests</div>
            <div class="text-2xl font-bold"><%= @agency.requests.count %></div>
          </div>

          <div>
            <div class="text-sm text-base-content/70">Last Request</div>
            <div class="font-semibold">
              <% if @agency.requests.any? %>
                <%= time_ago_in_words(@agency.requests.order(created_at: :desc).first.created_at) %> ago
              <% else %>
                No requests yet
              <% end %>
            </div>
          </div>
        </div>

        <div class="card-actions justify-end mt-4">
          <%= link_to admin_requests_path, class: "btn btn-sm btn-primary" do %>
            View Requests
            <span class="size-4"><%= heroicon "arrow-right", variant: :mini %></span>
          <% end %>
        </div>
      <% end %>
    </div>
  <% end %>
</div>
